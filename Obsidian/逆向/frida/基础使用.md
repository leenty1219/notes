一个不错的网站：[https://crifan.github.io/reverse_debug_frida/website/use_frida/frida_cli/debug_target.html](https://crifan.github.io/reverse_debug_frida/website/use_frida/frida_cli/debug_target.html)

## 1. frida

### 1.1 支持的绑定

- `Python` 地址：[https://github.com/frida/frida-python](https://github.com/frida/frida-python)
- `Node.js` 地址：[https://github.com/frida/frida-node](https://github.com/frida/frida-node)
- `Swift` 地址：[https://github.com/frida/frida-swift](https://github.com/frida/frida-swift)
- `.NET` 地址：[https://github.com/frida/frida-clr](https://github.com/frida/frida-clr)
- `GO` 地址：[https://github.com/frida/frida-go](https://github.com/frida/frida-go) 地址
- `Rust` 地址：[https://github.com/frida/frida-rust](https://github.com/frida/frida-rust)
- `QT/qml` 地址：[https://github.com/frida/frida-qml](https://github.com/frida/frida-qml)

### 1.2 移动端互操

- `iOS`和`frida` 地址：[https://github.com/frida/frida-objc-bridge](https://github.com/frida/frida-objc-bridge)
- `Android`和`frida` 地址：[https://github.com/frida/frida-java-bridge](https://github.com/frida/frida-java-bridge)

### 1.3 文档资料

```bash
➜  frida-trace frida --help
usage: frida [options] target

positional arguments:
  args                  extra arguments and/or target

options:
  -h, --help            展示帮助信息和退出
  -D ID, --device ID    连接一个已知的device ID
  -U, --usb             连接一个USB设备
  -R, --remote          连接远程的frida-server
  -H HOST, --host HOST  连接远程的frida-server，使用HOST
  --certificate CERTIFICATE
                        speak TLS with HOST, expecting CERTIFICATE
  --origin ORIGIN       connect to remote server with “Origin” header set to ORIGIN
  --token TOKEN         authenticate with HOST using TOKEN
  --keepalive-interval INTERVAL
                        set keepalive interval in seconds, or 0 to disable (defaults to -1 to auto-select based on transport)
  --p2p                 establish a peer-to-peer connection with target
  --stun-server ADDRESS
                        set STUN server ADDRESS to use with --p2p
  --relay address,username,password,turn-{udp,tcp,tls}
                        add relay to use with --p2p
  -f TARGET, --file TARGET
                        spawn FILE
  -F, --attach-frontmost
                        附加一个前台程序
  -n NAME, --attach-name NAME
                        附加到名称
  -N IDENTIFIER, --attach-identifier IDENTIFIER
                        attach to IDENTIFIER
  -p PID, --attach-pid PID
                        附加到PID
  -W PATTERN, --await PATTERN
                        await spawn matching PATTERN
  --stdio {inherit,pipe}
                        stdio behavior when spawning (defaults to “inherit”)
  --aux option          set aux option when spawning, such as “uid=(int)42” (supported types are: string, bool, int)
  --realm {native,emulated}
                        realm to attach in
  --runtime {qjs,v8}    script runtime to use
  --debug               enable the Node.js compatible script debugger
  --squelch-crash       if enabled, will not dump crash report to console
  -O FILE, --options-file FILE
                        text file containing additional command line options
  --version             show program's version number and exit
  -l SCRIPT, --load SCRIPT
                        load SCRIPT
  -P PARAMETERS_JSON, --parameters PARAMETERS_JSON
                        parameters as JSON, same as Gadget
  -C USER_CMODULE, --cmodule USER_CMODULE
                        load CMODULE
  --toolchain {any,internal,external}
                        CModule toolchain to use when compiling from source code
  -c CODESHARE_URI, --codeshare CODESHARE_URI
                        load CODESHARE_URI
  -e CODE, --eval CODE  evaluate CODE
  -q                    quiet mode (no prompt) and quit after -l and -e
  -t TIMEOUT, --timeout TIMEOUT
                        seconds to wait before terminating in quiet mode
  --pause               leave main thread paused after spawning program
  -o LOGFILE, --output LOGFILE
                        output to log file
  --eternalize          eternalize the script before exit
  --exit-on-error       exit with code 1 after encountering any exception in the SCRIPT
  --kill-on-exit        kill the spawned program when Frida exits
  --auto-perform        wrap entered code with Java.perform
  --auto-reload         Enable auto reload of provided scripts and c module (on by default, will be required in the future)
  --no-auto-reload      Disable auto reload of provided scripts and c module
```

- 官网文档入口: [Frida Docs](https://frida.re/docs/home/)
    - 入门指南=Getting Started
        - 快速入手: [Quick-start guide](https://frida.re/docs/quickstart/)
        - 安装: [Installation](https://frida.re/docs/installation/)
        - 操作模式: [Modes of Operation](https://frida.re/docs/modes/)
        - Gadget: [Gadget](https://frida.re/docs/gadget/)
        - 内部原理: [Hacking](https://frida.re/docs/hacking/)
        - Stalker: [Stalker](https://frida.re/docs/stalker/)
        - 演讲文档资料：[Presentations](https://frida.re/docs/presentations/)
    - 教程=Tutorials
        - 通用
            - 函数: [Functions](https://frida.re/docs/functions/)
            - 消息: [Messages](https://frida.re/docs/messages/)
        - 移动端
            - [iOS](https://frida.re/docs/ios/)
            - [Android](https://frida.re/docs/android/)
    - 案例=Examples
        - PC端
            - [Windows](https://frida.re/docs/examples/windows/)
            - [macOS](https://frida.re/docs/examples/macos/)
            - [Linux](https://frida.re/docs/examples/linux/)
        - 移动端
            - [iOS](https://frida.re/docs/examples/ios/)
            - [Android](https://frida.re/docs/examples/android/)
        - 其他
            - [JavaScript](https://frida.re/docs/examples/javascript/)
    - 工具=Tools
        - `frida`命令行工具: [Frida CLI](https://frida.re/docs/frida-cli/)
        - [frida-ps](https://frida.re/docs/frida-ps/)
        - [frida-trace](https://frida.re/docs/frida-trace/)
        - [frida-discover](https://frida.re/docs/frida-discover/)
        - [frida-ls-devices](https://frida.re/docs/frida-cli/)
        - [frida-kill](https://frida.re/docs/frida-kill/)
        - [gum-graft](https://frida.re/docs/gum-graft/)
    - API文档=API Reference
        - [JavaScript API](https://frida.re/docs/javascript-api/)
        - [C API](https://frida.re/docs/c-api/)
        - [Swift API](https://frida.re/docs/swift-api/)
        - [Go API](https://frida.re/docs/go-api/)
    - 其他细节=Miscellaneous
        - 最佳实践: [Best Practices](https://frida.re/docs/best-practices/)
        - 排错: [Troubleshooting](https://frida.re/docs/troubleshooting/)
        - 自己编译Frida=参与Frida开发: [Building](https://frida.re/docs/building/)
        - 占用系统空间: [Footprint](https://frida.re/docs/footprint/)
    - 起源和发展=Meta
        - [GSoC Ideas 2015](https://frida.re/docs/gsoc-ideas-2015/)
        - [GSoD Ideas 2023](https://frida.re/docs/gsod-ideas-2023/)
        - [History](https://frida.re/docs/history/)
- 其他
    - 教程
        - [Frida basics - Frida HandBook (learnfrida.info)](https://learnfrida.info/basic_usage/)
        - [Frida HandBook](https://learnfrida.info/)

### 1.4 配合JS使用

- 可以自己写
    - 比如 [iOS的ObjC](https://crifan.github.io/reverse_debug_frida/website/frida_example/frida_example/frida/ios_objc/README.md) 中的各种例子
- 也可以，借用别人已有的
    - 比如 [Frida Codeshare](https://crifan.github.io/reverse_debug_frida/website/frida_example/frida_example/online_other_case/frida_codeshare.md)

## 2. frida 扩展

### 2.1 frida-ps

获取当前手机活跃的进程

`frida-ps -U` 当前以伴生活为例，得到的工程名 BSHProject ，进程ID 18899

- 18899 BSHProject

`frida-ps -Ua` 列出当前USB设备的所有运行设备

### 2.2 frida-trace hook函数

```bash
# hook CCCrypt 函数 
frida-trace -U -i CCCrypt -p <pid>
# -i 表示hook C函数，-m hook OC函数
frida-trace -U -p 21144 -m "-[NSData initWithContentsOfFile:]"

#bundleID
frida-trace -U -N com.moutai.mall
frida-trace -U -N com.moutai.mall -i "CC_MD5"
```

### 2.3 frida-dump砸壳

查看当前程序的bundleid `python3 ./dump.py -l`

对某一程序砸壳：`python3 ./dump.py com.banshenghuo.banshenghuo`

砸壳中记得要保持手机活跃并打开APP，不然可能连接中断

### 2.4 查看bundleID

`python3 ./dump.py -l | grep mou`

## 3. objection

`objection -g 18899 explore`

关闭SSL校验：`ios-sslpinning-disable`

## 4. UI定位

## 3.1 使用Reveal

**暂无**

## 3.2 frida打印UI

使用frida，`AloneMonkey`有提供一些脚本事例`iOSfrida`

# 4. Hook加密

大部分的H5的加密都是做在js，极少部分可能在OC里面

# 5. JS

## 5.1 打印堆栈信息

```jsx
// 打印调用方法的堆栈信息
log('Methods :' + Thread.backtrace(this.context,Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join('\\n') + '\\n');
```

## 5.2 读取参数文本

```jsx
defineHandler({
  onEnter(log, args, state) {
  // 将args[0]的地址读取为CString，读取长度为 args[1].toInt32() （第二个参数）
    log('CC_MD5() onEnter: ' + args[0].readCString(args[1].toInt32()));
    this.args2 = args[2]; // 将args[2] 参数使用指针指向args2，在onLeave时读取结果
  },

  onLeave(log, retval, state) {
    log('CC_MD5() onLeave: ' + hexdump(this.args2, {length: 16}));
  }
});
```

## 5.3 读取内存二进制数据

```jsx
// 使用hexdump来读取二进制数据，使用{length :Int}来制定读取的长度；MD5是16个字节
log('CC_MD5() onLeave: ' + hexdump(this.args2, {length: 16}));
```

## 5.4 读取OC对象

```jsx
defineHandler({
  onEnter(log, args, state) {
   // 如果是hook的OC方法，参数/返回值为OC对象，可以打印OC对象
   log(ObjC.Object(args[2])); // args[2] 为第一个参数
  },

  onLeave(log, retval, state) {
    
  }
});
```

## 5.5 hook js请求

修改路径为：`_handlers/WXStreamModule/_buildRequestWithOptions_callbackRsp_.js`

```jsx
// 使用命令为
// firda-trace -UF -m "-[WXStreamModule _buildRequestWithOptions:callbackRsp:]"
defineHandler({ 
  onEnter(log, args, state) {
	   log('- [WXStreamModule _buildRequestWithOptions:${Objc.Object(args[2])} callbackRsp:${Objec.Object{args[3]}}]');
  },

  onLeave(log, retval, state) {
    log('CC_MD5() onLeave: ' + hexdump(this.args2, {length: 16}));
  }
});
```

如果想调试对应的数据，就找到对应的js文件来修改/插入一些值

eg.UnitApp的js文件大多都在 `/var/mobile/Containers/Data/Application/xxxxxx/Library/Pandora/apps/_UNI_2F9F9AV/www/app-server.js`

如果找不到对应的文件，可以使用find命令查找

```jsx
cd / # 切换到根目录
find . -name app-server.js
```

## 5.6 修改入参

```jsx
//修改为NSString
var str = ObjC.classes.NSString;
var newValue = str.stringWithFormat_("text");
args[2] = newValue
// 修改为int型
args[2] = ptr(1);
```

## 5.7 事例

### 5.7.1 CC_MD5

### 5.7.2 CCCrypt

```objectivec
CCCryptorStatus CCCrypt(
    CCOperation op,         // 0:加密 1:解密
    CCAlgorithm alg,        // 加密方式 CCAlgorithm 枚举在下面
    CCOptions options,      // 填充方式：枚举定义在下面
    const void *key,        // key
    size_t keyLength,       // key 长度
    const void *iv,         // iv向量
    const void *dataIn,     // 数据输入
    size_t dataInLength,    // 数据输入长度
    void *dataOut,          // 加密后的秘文
    size_t dataOutAvailable, // 
    size_t *dataOutMoved // 
)
// alg 的定义
enum {
    kCCAlgorithmAES128 = 0, /* Deprecated, name phased out due to ambiguity with key size */
    kCCAlgorithmAES = 0,
    kCCAlgorithmDES,
    kCCAlgorithm3DES,
    kCCAlgorithmCAST,
    kCCAlgorithmRC4,
    kCCAlgorithmRC2,
    kCCAlgorithmBlowfish
};
typedef uint32_t CCAlgorithm;

enum {
    /* options for block ciphers */
    kCCOptionPKCS7Padding   = 0x0001,
    kCCOptionECBMode        = 0x0002
    /* stream ciphers currently have no options */
};
typedef uint32_t CCOptions;
```

# 6.frida配合js直接使用

使用命令

```jsx
// -f以bundleID来注入 --no-pause不暂停 -l js文件
frida -U -f com.moutai.mall --no-pause -l js文件
```

## 6.1寻找模块基地址

```jsx
// 寻找基地址
var baseAddr = Module.findBaseAddress("moutai-mall");
// 添加偏移地址
Interceptor.attach(baseAddr.add(0x6AA610), {
    onEnter: function(args) {
        console.log("onEnter");
    },onLeave: function(retval) {
        retval.replace(0x0); 
        console.log("onLeave");
    }
});
```

## 6.2 查找变量方法

```jsx
// 创建一个 ApiResolver 来遍历方法
var resove = new ApiResolver("objc");
resove.enumerateMatches("*[* *ail*]", {
    onMatch: function(match) {
        console.log("Match: " + match.name);
        var addr = match.address;
        Interceptor.attach(addr, {
            onEnter: function(args) {
                console.log("onEnter");
            },onLeave: function(retval) {
                retval.replace(0x0); 
                console.log("onLeave");
            }
        });
        console.log("Match: " + match.address);
    },
    onComplete: function() {
        console.log("All done!");
    }
});
```

## 6.3 遍历导入模块地址

```jsx
// 遍历导入函数
Module.enumerateExports("moutai-mall", {
    onMatch: function(exp) {
        console.log(exp.name);
    },
    onComplete: function() {
        console.log("done!");
    }
});
// 看起来这个才是
Process.findModuleByName("moutai-mall").enumerateExports().forEach(function(exp) {
    console.log(exp.name);
});
```

## 6.4 寻找函数

```jsx
var func_md5 = Module.findExportByName("TDProtocol", "md5");
Interceptor.attach(func_md5, {
    onEnter: function(args) {
        // 打印函数栈
        // console.log(Thread.backtrace(this.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join("\\n") + "\\n");
        console.log("onEnter");
    },onLeave: function(retval) {
        retval.replace(0x0); 
        console.log("onLeave");
    }
});
```

## 6.5 OC函数

```jsx
var imp = ObjC.classes.YXAlertView["- initWithNoticeInfo:enterTitle:"];
Interceptor.attach(imp.implementation, {
    onEnter: function(args) {
        console.log("onEnter");
    },onLeave: function(retval) {
        retval.replace(0x0); 
        console.log("onLeave");
    }
});

// 动态库里面的函数，例如libProtocol库的sign函数
var fn = ObjC.classes.libProtocol['+ sign:'].implementation;
Interceptor.attach(fn, {
    onEnter: function(args) {
        console.log("libProtocol sign: " +  ObjC.Object(args[2]));
    }, onLeave: function(retval) {
        console.log("libProtocol sign: " +  ObjC.Object(retval));
    }
});
```

## 6.6 hook某一行的代码地址

```jsx
var baseAddr = Module.findBaseAddress("com.moutai.mall");
var imp = baseAddr.add(0x93092); // 某一行的地址
Interceptor.attach(imp, {
    onEnter: function(args) {
        console.log("onEnter");
    },onLeave: function(retval) {
        retval.replace(0x0); 
        console.log("onLeave");
    }
});
```

# 7. IDA的操作

1.按F5 转换为C代码

2.按空格切换代码和view视图

# 8. 查看APP的路径

1.首先查看当前的活跃进程，`ps aux | grep wechat`

从手机copy文件到电脑

```bash
scp -r root@10.50.10.30:手机路径 桌面路径
```