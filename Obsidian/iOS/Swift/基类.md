## 1. Enum

```swift
enum RefreshState {
    enum RefreshLocation {
        case header // 头
        case footer // 脚
    }
    case beginRefresh // 开始刷新
    case endRefresh(RefreshLocation) // 停止刷新(部位)
    case endNoMore // 加载完所有数据
    case unknown // 未知
}
```

## 2. TableViewController

```swift
class TableViewController: ViewController, UIScrollViewDelegate {

//    var isEmptyPlaceHodler:Bool = true

    lazy var tableView: UITableView = {
        return UITableView(frame: view.bounds, style: .plain).then {
            $0.emptyDataSetSource = self
            $0.emptyDataSetDelegate = self
            $0.rowHeight = UITableView.automaticDimension
            $0.estimatedRowHeight = 44
            $0.sectionHeaderHeight = 30
            $0.backgroundColor = .clear
            $0.rx.setDelegate(self).disposed(by: rx.disposeBag)
            $0.separatorInset = UIEdgeInsets(top: 0, left: 0, bottom: 0, right: 0)
            $0.cellLayoutMarginsFollowReadableWidth = false
            $0.tableFooterView = UIView()
            view.addSubview($0)
//            $0.snp.makeConstraints { make in
//                make.edges.equalToSuperview()
//            }
        }
    }()

    override func bindViewModel() {
        super.bindViewModel()
        if let viewModel = self.viewModel {
            viewModel.refreshSubject.asDriver(onErrorJustReturn: .unknown).drive(self.rx.refreshState).disposed(by: rx.disposeBag)
        }
    }

}

extension TableViewController: DZNEmptyDataSetSource, DZNEmptyDataSetDelegate {
    func image(forEmptyDataSet scrollView: UIScrollView!) -> UIImage! {
        return R.image.emptyHome()
    }
    func description(forEmptyDataSet scrollView: UIScrollView!) -> NSAttributedString! {
        return NSAttributedString(
            string: R.string.localizable.scrollViewEmptyTitle(),
            attributes: [
                .font: UIFont.systemFont(ofSize: 13, weight: .medium),
                .foregroundColor: UIColor(hexString: "#C9CFDD")!
            ]
        )
    }
    func emptyDataSetShouldAllowScroll(_ scrollView: UIScrollView!) -> Bool {
        return true
    }
    func verticalOffset(forEmptyDataSet scrollView: UIScrollView!) -> CGFloat {
        -100
    }
}

extension Reactive where Base: TableViewController {
     var refreshState: Binder<RefreshState> {
        return Binder(self.base) { tableViewController, state in
            switch state {
            case .beginRefresh:
                tableViewController.tableView.mj_footer?.resetNoMoreData()
            case .endNoMore:
                tableViewController.tableView.mj_footer?.endRefreshingWithNoMoreData()
            case .endRefresh(let location):
                switch location {
                case .footer: tableViewController.tableView.mj_footer?.endRefreshing()
                case .header: tableViewController.tableView.mj_header?.endRefreshing()
                }
            case .unknown:break
            }
        }
    }
}
```

## 3. CollectionViewController

```swift
class CollectionViewController: ViewController {

    lazy var collectionView: UICollectionView = {

        return UICollectionView(frame: view.bounds, collectionViewLayout: UICollectionViewFlowLayout()).then {
            $0.emptyDataSetSource = self
            $0.emptyDataSetDelegate = self
            view.addSubview($0)
        }
    }()

    func setItemSize(_ size: CGSize) {
        if size.width == 0 || size.height == 0 {return}
        if let layout = collectionView.collectionViewLayout as? UICollectionViewFlowLayout {
            layout.itemSize = size
        }
    }

}

extension CollectionViewController: DZNEmptyDataSetSource, DZNEmptyDataSetDelegate {
    func image(forEmptyDataSet scrollView: UIScrollView!) -> UIImage! {
        return UIImage()
    }
    func description(forEmptyDataSet scrollView: UIScrollView!) -> NSAttributedString! {
        return NSAttributedString(
            string: "暂无数据",
            attributes: [
                .font: UIFont.systemFont(ofSize: 13, weight: .medium),
                .foregroundColor: UIColor(hexString: "#C9CFDD")!
            ]
        )
    }
    func emptyDataSetShouldAllowScroll(_ scrollView: UIScrollView!) -> Bool {
        return true
    }
}

extension Reactive where Base: CollectionViewController {
    internal var refreshState: Binder<RefreshState> {
        return Binder(self.base) { collectionViewController, state in
            switch state {
            case .beginRefresh:
                collectionViewController.collectionView.mj_footer?.resetNoMoreData()
            case .endNoMore:
                collectionViewController.collectionView.mj_footer?.endRefreshingWithNoMoreData()
            case .endRefresh(let location):
                switch location {
                case .footer: collectionViewController.collectionView.mj_footer?.endRefreshing()
                case .header: collectionViewController.collectionView.mj_header?.endRefreshing()
                }
            case .unknown:break
            }
        }
    }
}
```

## 4. ViewController

```swift
class ViewController: UIViewController, UIGestureRecognizerDelegate {

    var viewModel: ViewModel?

    lazy var refresh = {BehaviorSubject<Void>(value: ())}()

    override func viewDidLoad() {
        super.viewDidLoad()
        loadUI()
        bindViewModel()
    }

    // 左侧的按钮
    lazy var leftBarButton: UIButton = {
        return UIButton(frame: CGRect(x: 0, y: 0, width: 44, height: 44)).then {
            self.navigationItem.leftBarButtonItem = UIBarButtonItem(customView: $0)
        }
    }()

    // 左侧的按钮
    lazy var rightBarButton: UIButton = {
        return UIButton(frame: CGRect(x: 0, y: 0, width: 44, height: 44)).then {
            self.navigationItem.rightBarButtonItem = UIBarButtonItem(customView: $0)
        }
    }()

    init(viewModel: ViewModel?) {
        self.viewModel = viewModel
        super.init(nibName: nil, bundle: nil)
    }

    override init(nibName nibNameOrNil: String?, bundle nibBundleOrNil: Bundle?) {
        super.init(nibName: nibNameOrNil, bundle: nibBundleOrNil)
    }

    required init?(coder: NSCoder) {
        super.init(coder: coder)
    }

    // 绑定模型
    func bindViewModel() {
        guard let viewModel = self.viewModel else {return}

        viewModel.message
            .asDriver(onErrorJustReturn: "")
            .drive(self.rx.toastMessage)
            .disposed(by: rx.disposeBag)

        viewModel.requestState
            .asDriver(onErrorJustReturn: .unknown)
            .drive(self.rx.requestState)
            .disposed(by: rx.disposeBag)
    }

    func loadUI() {
        view.backgroundColor = .white
        // 添加返回按钮
        if let navigationController = self.navigationController, navigationController.viewControllers.count > 1 {
            self.leftBarButton.setImage(R.image.icon_return_black(), for: .normal)
            self.leftBarButton.rx.tap.asDriver().drive(self.rx.return).disposed(by: rx.disposeBag)
            navigationController.interactivePopGestureRecognizer?.delegate = self
        }
    }
}

// MARK: - 基类方法
extension ViewController {
    // 登录
    func login() -> UIViewController {
        let login = LoginViewController()
        login.loginHandlerSubject.filterMap { loginType -> FilterMap<UIViewController?> in
            switch loginType {
            case .apple:return .ignore
            case .google:return .ignore
            case .email:
                return .map(EmailLoginViewController(viewModel: nil).then {$0.hidesBottomBarWhenPushed = true})
            case .phone:
                return .map(PhoneLoginViewController(viewModel: PhoneLoginViewModel()).then {$0.hidesBottomBarWhenPushed = true})
            }
        }.asDriver(onErrorJustReturn: nil)
        .unwrap()
        .drive(self.rx.push)
        .disposed(by: rx.disposeBag)
        return login
    }
    // 开通会员
    func member() -> UIViewController {
//        let login = MemberAlertController()
//        login.unlockMemberSubject.bind {[weak self] _ in
//            guard let self = self else {return}
//            let member = R.nib.memberViewController(owner: nil)!
//            member.hero.isEnabled = true
//            member.hero.modalAnimationType = .selectBy(presenting: .push(direction: .left), dismissing: .pull(direction: .right))
//            member.modalPresentationStyle = .fullScreen
//            self.present(member, animated: true, completion: nil)
//        }.disposed(by: rx.disposeBag)
//        return login
        let member = R.nib.memberViewController(owner: nil)!
        member.hero.isEnabled = true
        member.hero.modalAnimationType = .selectBy(presenting: .push(direction: .left), dismissing: .pull(direction: .right))
        member.modalPresentationStyle = .fullScreen
        return member
    }

}

extension Reactive where Base: UIViewController {
    var requestState: Binder<RequestState> {
        return Binder(self.base) { controller, state in
            switch state {
            case .start:
                UIApplication.shared.isNetworkActivityIndicatorVisible = true
                controller.view.makeToastActivity(controller.view.center)
            case .finish:
                UIApplication.shared.isNetworkActivityIndicatorVisible = false
                controller.view.hideToastActivity()
            case .error:
                UIApplication.shared.isNetworkActivityIndicatorVisible = false
                controller.view.hideToastActivity()
                controller.toastMessage(R.string.localizable.requestError())
            case .unknown:break
            }
        }
    }
    var toastMessage: Binder<String?> {
        return Binder(self.base) { viewController, value in
            viewController.toastMessage(value)
        }
    }

    var `return`: Binder<Void> {
        return Binder(self.base) { viewController, _ in
            if let nav = viewController.navigationController {
                nav.popViewController()
            } else {
                viewController.dismiss(animated: true, completion: nil)
            }
        }
    }

    var push: Binder<UIViewController?> {
        return Binder(self.base) { viewController, value in
            guard let value = value else {return}
            if value.isKind(of: LoginViewController.classForCoder()) || value.isKind(of: MemberAlertController.classForCoder()) || value.isKind(of: MemberViewController.classForCoder()) {
                viewController.present(value, animated: true, completion: nil)
            } else {
                viewController.navigationController?.pushViewController(value)
            }

        }
    }

    var present: Binder<UIViewController?> {
        return Binder(self.base) { viewController, value in
            guard let value = value else {return}
            viewController.present(value, animated: true, completion: nil)
        }
    }
}

extension UIViewController {
    func toastMessage(_ message: String?) {
        guard let text = message, !text.isEmpty else {return}
        let style = ToastStyle()
        self.view.makeToast(text,
                            duration: 1.25,
                            point: self.view.center,
                            title: nil,
                            image: nil,
                            style: style,
                            completion: nil
        )
    }
}

```

## 5. Notifications

```swift
extension NSNotification.Name {
    static let locationAddress = NSNotification.Name("com.location.current.address")
    static let loginNotification = NSNotification.Name("com.location.login")
}
```

## 6. ViewModel

```swift
protocol ViewModelType {
    associatedtype Input
    associatedtype Output

    func transform(input: Input) -> Output
}

class ViewModel: NSObject {
    // toast 消息
    lazy var message: RxSwift.PublishSubject<String?> = {
        return RxSwift.PublishSubject<String?>()
    }()

    lazy var member: BehaviorSubject<Bool> = {
        return BehaviorSubject<Bool>(value: false)
    }()

    lazy var refreshSubject: RxSwift.PublishSubject<RefreshState> = {
        return RxSwift.PublishSubject<RefreshState>()
    }()
    // 请求状态
    lazy var requestState: RxSwift.PublishSubject<RequestState> = {
        return RxSwift.PublishSubject<RequestState>()
    }()

}
```